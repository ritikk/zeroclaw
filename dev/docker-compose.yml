# Development Environment for ZeroClaw Agentic Testing
#
# Use this for:
# - Running the agent in a sandboxed environment
# - Testing dangerous commands safely
# - Developing new skills/integrations
#
# Usage:
#   cd dev && ./cli.sh up
#   or from root: ./dev/cli.sh up
name: zeroclaw-dev
services:
  # ── The Agent (Development Image) ──
  # Builds from source using the 'dev' stage of the root Dockerfile
  zeroclaw-dev:
    build:
      context: ..
      dockerfile: Dockerfile
      target: dev
    container_name: zeroclaw-dev
    restart: unless-stopped
    environment:
      - ZEROCLAW_GATEWAY_PORT=42617
      - SANDBOX_HOST=zeroclaw-sandbox
    secrets:
      - source: zeroclaw_env
        target: zeroclaw_env
    entrypoint: ["/bin/bash", "-lc"]
    command:
      - |
        if [ -f /run/secrets/zeroclaw_env ]; then
          set -a
          . /run/secrets/zeroclaw_env
          set +a
        fi
        exec zeroclaw daemon --port "${ZEROCLAW_GATEWAY_PORT:-42617}" --host "[::]"
    volumes:
      # Mount full .zeroclaw dir so config, secret key, SQLite memory DB, and
      # daemon state all persist across restarts. Secret key must be collocated
      # with config.toml for ChaCha20-Poly1305 decryption to work.
      - ../data/.zeroclaw:/zeroclaw-data/.zeroclaw
      # Mount shared workspace
      - ../playground:/zeroclaw-data/workspace
      # Open-skills repository (cloned by zeroclaw at runtime)
      - ../data/open-skills:/zeroclaw-data/open-skills
      # Network share — Collab dropzone (SMB //192.168.4.41/ritikclaw/Collab mounted on host)
      - ../mounts/clawshared/Collab:/zeroclaw-data/clawshared
    security_opt:
      - no-new-privileges:true
    ports:
      - "127.0.0.1:42617:42617"
    networks:
      - dev-net

  # ── The Sandbox (Ubuntu Environment) ──
  # A fully loaded Ubuntu environment for the agent to play in.
  sandbox:
    build:
      context: sandbox # Context relative to dev/
      dockerfile: Dockerfile
    container_name: zeroclaw-sandbox
    hostname: dev-box
    command: ["tail", "-f", "/dev/null"]
    working_dir: /home/developer/workspace
    user: developer
    environment:
      - TERM=xterm-256color
      - SHELL=/bin/bash
    volumes:
      - ../playground:/home/developer/workspace # Mount local playground
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 256M
    networks:
      - dev-net

networks:
  dev-net:
    driver: bridge

secrets:
  zeroclaw_env:
    file: ../.env
